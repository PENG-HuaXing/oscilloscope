# 基本原理

### 计算积分谱

对于示波器波形文件， 我们需要在一个时间窗口内寻找单光电子信号， 该积分窗口是在测量单光电子调试的过程中所确定的一个大概时间区间， 要求大部分单光电子信号都出现在时间窗口内。

示波器记录的数据是时间[s]-电压[V]数据， 为了得到单光电子经过PMT增益后的电荷，我们需要对示波器的波形进行积分。时间窗口开始和结束时间分别为$t_{w1}, t_{w2}$电压值为$U$，时间为$t$，则有
$$
S = \int_{t_{w1}}^{t_{w2}}U\mathrm{d}t \tag{1}
$$
在实际测量过程中示波器的基线并不是在0V的位置， 并且不可能是常数， 经过测量我们法线示波器的基线是一个高斯分布， 为了扣除基线摆动， 我们需要在信号临近区域计算基线的平均值，基线时间窗口$t_{p1}, t_{p2}$，基线电压为$U_{p}$。则有下面的公式
$$
\mathrm{ped} = \frac{\int_{t_{p1}}^{t_{p2}}U_p\mathrm{d}t}{t_{p2} - t_{p1}}\tag{2}
$$
扣除基线后我们可以得到较为准确的信号的积分谱
$$
\begin{equation}
\begin{aligned}
S_{ped} &= \int_{t_{w1}}^{t_{w2}}(U-\mathrm{ped})\mathrm{d}t \\
&= S-\mathrm{ped}\cdot  (t_{w2} - t_{w1}) \\
&= S- \mathrm{ped} \cdot \Delta t_w 
\end{aligned}
\tag{3}
\end{equation}
$$

### 绘制Histgram以及拟合

在单光电子谱分析模块中可以对绘制出来的直方图进行不同模型的拟合，并且得到拟合参数。拟合使用`scipy.optimize.curve_fit`模块，拟合模型有下面几个可供选择：
$$
\mathrm{Gauss}(x, A, \mu, \sigma) = \frac{A}{\sqrt{2\pi}\cdot \sigma}\cdot \exp(-\frac{(x-\mu)^2}{2\sigma^2}) \tag{4}
$$
此为高斯拟合模型， 用于局部拟合单光电子谱中与高斯函数类似的峰
$$
\begin{aligned}
S(x) \approx &\left\{\frac{1}{\sigma_{0} \sqrt{2 \pi}} \exp \left(-\frac{\left(x-Q_{0}\right)^{2}}{2 \sigma_{0}^{2}}\right) \right\} \mathrm{e}^{-\mu}\\&
+\sum_{n=1}^{\infty} \frac{\mu^{n} \mathrm{e}^{-\mu}}{n !} \times \frac{1}{\sigma_{1} \sqrt{2 \pi n}}  \times \exp \left(-\frac{\left(x-Q_{0}-n Q_{1}\right)^{2}}{2 n \sigma_{1}^{2}}\right)
\end{aligned}
\tag{5}
$$
这种模型中将基线分布用单个高斯函数代替，可以对整个光电子谱的全域进行拟合
$$
\begin{aligned}
S_{\text {real }}(x) \approx &\left\{\frac{(1-w)}{\sigma_{0} \sqrt{2 \pi}} \exp \left(-\frac{\left(x-Q_{0}\right)^{2}}{2 \sigma_{0}^{2}}\right)+w \theta\left(x-Q_{0}\right)\right.\\
&\left.\times \alpha \exp \left[-\alpha\left(x-Q_{0}\right)\right]\right\} \mathrm{e}^{-\mu}+\sum_{n=1}^{\infty} \frac{\mu^{n} \mathrm{e}^{-\mu}}{n !} \\
& \times \frac{1}{\sigma_{1} \sqrt{2 \pi n}} \\
& \times \exp \left(-\frac{\left(x-Q_{0}-Q_{\mathrm{sh}}-n Q_{1}\right)^{2}}{2 n \sigma_{1}^{2}}\right)
\end{aligned}
\tag{6}
$$
这个模型中将基线分成两部分，其中一个是高斯函数，另一个是指数衰减函数，相较与用单一高斯函数来拟合基线，这个模型更加精准一些。

拟合过程使用直方图中每个bin的中点数值作为数据x，使用直方图中每个bin的cotent作为数据y，对数据点x,y进行最小二乘拟合，即可得到拟合结果。拟合过程中我们发现，一般当数据量在5次方量级的时候， 直方图的最高数值可以在3次方量级左右，但是直方图横座标刻度为积分数值，一般在-10量级，这就导致拟合参数之间差距过大，由于拟合过程并非解析的，而是一步步迭代，因此这种情况往往会导致拟合结果不好。所以一般在拟合之前我们会对数据乘上一个系数， 令直方图横座标和纵座标刻度差距减小一些，这样拟合效果会更好。

### QDC分析模块

QDC分析可以读取QDC插件产生的数据， 目前读取数据的格式是txt文本， 数据之间用table`(\t)`来分隔开， 每一列数据为一个通道，每一行数据为一个道址， 指定行指定列的数据就是该通道的直方图中对应道址的数据统计量，拟合过程与上面描述相同，不过多说明。

### 后脉冲分析模块

后脉冲分析模块中我们首先要寻找出现信号的波形数据，再从信号波形数据中找出后脉冲。这里主要通过之前计算得到的单光电子谱数据中计算得到的积分电荷量来判选信号数据，只有当积分电荷量的绝对值大于某一个阈值时， 我们便认为该波形是信号波形。之后我们再从后脉冲时间区域（一般在主信号时间窗口之后到几十微妙）寻找后脉冲信号。 在这里我们设定一个电压触发阈值（幅值触发阈值），当后脉冲时间区域内存在过阈信号，此时便找到这个信号的极值时刻$t_{0}$作为后脉冲发生的时间，此处不考虑上升时间是因为后面分析可以发现信号的上升时间一般在10ns以内，而后脉冲多发生分布在几十微秒的时间范围内，因此三个数量级的差距我们可以暂且忽略。在找到后脉冲后需要设定一个后脉冲时间窗口进行积分$\Delta t_{AP}$， 后脉冲积分时间窗口的设定最好与主脉冲积分时间窗口相同，这样后脉冲的积分结果可以与主脉冲信号，或者说是单光电子信号进行对比。积分区间设定为$\left(t_{0}-\frac{\Delta t_{AP}}{2}, t_0+\frac{\Delta t_{AP}}{2}\right)$。最后还是要扣除信号基线。按照上述步骤便可以得到所有后脉冲信号的时间-积分电荷值，绘制成散点图可以初步分析后脉冲的一些规律。

### 上升时间分布

由于示波器采集到的波形中信号下降存在明显的震荡，因此我们目前只分析上升时间的分布。上升时间的定义为上升沿的幅度的 10% 到 90% 之间的时间差，而对应的上升沿幅度应为示波器中信号极值与基线之差。由于上升过程中，示波器信号存在两个拐点，因此我们可以使用三次函数进行拟合，当然也可以用线性函数进行拟合

对于线性拟合， 需要首先找出信号的上升沿幅度， 基线可以选择之前计算积分电荷谱的过程中所计算的基线数值，或是重新计算。幅值则可以通过寻找来信号极值与基线之差来确定$A = \left|\mathrm{ped} - U_{ext}\right|$。 之后从信号极值处的数据点向前寻找信号，直到出现第一个信号数据点满足$\left|A_{90}-\mathrm{ped}\right| < 0.9 \times\left|\mathrm{ped}-U_{ext}\right|$，以及$\left|A_{10}-\mathrm{ped}\right| < 0.1\times\left|\mathrm{ped}-U_{ext}\right|$。使用$A_{10}$和$A_{90}$之间的数据点进行线性拟合，最后通过得到的线性函数和上升沿幅度10%以及90%的交点作为上升时间$t_{10}$和$t_{90}$，最后使用直方图绘制出上升时间分布$\Delta t_{R} = t_{90} - t_{10}$。

对于三次函数拟合，寻找$A_{10}$和$A_{90}$的方法与之前相同，只是为了体现三次函数的两个拐点特性， 我们在$A_{90}$点再向右扩展5个数据点，$A_{10}$向左扩展5个数据点，定义为$A_{905}$和$A_{105}$，使用$A_{905}$和$A_{105}$之间的数据对三次函数进行拟合，计算10%，90%交点得出上升时间分布$\Delta t_R = t_{90} - t_{10}$

由于并非所有数据点都是都是较为标准的波形图谱，因此会有部分信号波形拟合结果较差，我们采用$R^2$来表示拟合优度
$$
\begin{aligned}
\mathrm{SST} = &\sum_{i=1}^{n}\left(y_{i}-\bar{y}\right)^{2} \\
\mathrm{SSR} = &\sum_{i=1}^{n}\left(\hat{y}_{i}-\bar{y}\right)^{2} \\
\mathrm{SSE} = &\sum_{i=1}^{n}\left(y_{i}-\hat{y}_{i}\right)^{2}
\end{aligned}
\tag{7}
$$
其中$y$为待拟合参数， $\bar {y}$为待拟合参数均值，拟合值为 $\hat{y}$。$\mathrm{SST}$是总平方和， $\mathrm{SSR}$是回归平方和， $\mathrm{SSE}$是残差平方和。

拟合优度$R^2$定义为
$$
R^2 = 1 - \frac{\mathrm{SSE}}{\mathrm{SST}} \tag{8}
$$
这之后我们便可以通过$R^2$来衡量拟合优度，剔除那些拟合效果不好的波形数据。

### 基线扣除问题

对于计算电荷积分谱的基本公式中$S_{ped} = S - \mathrm{ped}\cdot\Delta t_w$， 将$S_{ped}$用随机变量$X$表示， $\mathrm{ped} \cdot \Delta t_w$用随机变量$Y$表示， $S$用随机变量$Z$表示，通过实际测量我们发现基线随机变量$Y$服从正态分布， 而积分谱$S_{ped} = X$服从公式(6)分布，因此随机变量$S=Z$应该是服从$X+Y$的分布，也就是随机变量$Z$是正态分布和(6)分布的卷积。 但是实际中我们有一点需要注意我们测量的基线$\mathrm{ped}$是位于信号窗口附近，而真正的信号窗口内部的基线由于有信号干扰是无法测量得到的，也就是说我们测量的是$\mathrm{ped'}$而非$\mathrm{ped}$，服从正态分布的是$Y'$，至于真正的$Y$分布我们只能推测应该是和$Y'$同分布， 而真正信号窗口内的基线是如何分布的我们是无法测得的。但是我们可以做如下计算来证明：

假设$\mathrm{ped}$和$\mathrm{ped'}$同分布，即$Y$与$Y'$同分布，则有
$$
Z = X + Y'
$$
实际中$Z$分布可以测量， $X$分布和$Y'$可以通过测量数据拟合得到相应的$PDF$为$f, g$，采用scipy中的`scipy.signal.convolve`模块计算$(f\ast g)(x)$，两个分布的卷积，我们会发现理论计算出来的卷积分布函数和测量出来的$Z$直方图符合的相当好，因此便可以证明$\mathrm{ped}$和$\mathrm{ped'}$同分布。

此外我们可以发现，基线分布的宽度相较与电荷积分谱而言无法忽略，若是将基线当作0常数来计算电荷积分谱则得到的结果与真实值相差较大。

